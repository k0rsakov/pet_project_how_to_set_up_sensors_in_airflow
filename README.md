# –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Sensors –≤ Airflow

https://www.notion.so/korsak0v/Data-Engineer-185c62fdf79345eb9da9928356884ea0

## –û –≤–∏–¥–µ–æ

üî• –•–æ—á–µ—à—å, —á—Ç–æ–±—ã –≤–∏—Ç—Ä–∏–Ω—ã –≤ DWH –Ω–µ –∂–∏–ª–∏ —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é –∏ –≤—Å–µ–≥–¥–∞ –∂–¥–∞–ª–∏ —Å–≤–æ–∏ ODS-—Å–ª–æ–∏? –í
—ç—Ç–æ–º [–≤–∏–¥–µ–æ](https://youtu.be/rDTDUVOa7mc) —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Sensors –≤ Apache Airflow, —á—Ç–æ–±—ã DAG‚Äô–∏
—Ä–∞–±–æ—Ç–∞–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–µ —É–ø–∏—Ä–∞–ª–∏—Å—å –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π poking –∏ —Ç–∞–π–º–∞—É—Ç—ã.

–°—Å—ã–ª–∫–∏:

- –ú–µ–Ω—Ç–æ—Ä—Å—Ç–≤–æ/–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ Data
  Engineering ‚Äî https://korsak0v.notion.site/Data-Engineer-185c62fdf79345eb9da9928356884ea0
- TG-–∫–∞–Ω–∞–ª ‚Äî https://t.me/DataLikeQWERTY
- Instagram ‚Äî https://www.instagram.com/i__korsakov/
- Habr ‚Äî https://habr.com/ru/users/k0rsakov/publications/articles/

üîç –ß—Ç–æ –≤ –≤–∏–¥–µ–æ:

- üß† –ß—Ç–æ —Ç–∞–∫–æ–µ Sensors –≤ Airflow –∏ –∑–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö DWH-–ø–∞–π–ø–ª–∞–π–Ω–∞—Ö
- üõ∞Ô∏è –†–∞–∑–±–æ—Ä ExternalTaskSensor –Ω–∞ –∂–∏–≤—ã—Ö DAG‚Äô–∞—Ö: ODS ‚Üí DM
- ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ–Ω—Å–æ—Ä–æ–≤: mode, poke_interval, timeout, soft_fail ‚Äî –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –∫–æ–≥–¥–∞ –∫–∞–∫–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- ‚è±Ô∏è –ö–∞–∫ catchup –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É —Å–µ–Ω—Å–æ—Ä–æ–≤ –∏ –ø–æ—á–µ–º—É –∏–∑‚Äë–∑–∞ –Ω–µ–≥–æ –ª–µ–≥–∫–æ ¬´–ø–æ—Ç–µ—Ä—è—Ç—å¬ª DAGRun
- üß© –°—Ü–µ–Ω–∞—Ä–∏–π: –∫–æ–≥–¥–∞ –≤–∏—Ç—Ä–∏–Ω–∞ (dm) —Å—Ç–∞—Ä—Ç—É–µ—Ç —Ä–∞–Ω—å—à–µ ODS ‚Äî –∏ –∫–∞–∫ —ç—Ç–æ —á–∏–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ Sensors
- üìâ –ü—Ä–∏–º–µ—Ä DAG –±–µ–∑ —Å–µ–Ω—Å–æ—Ä–æ–≤: ¬´–ø—É—Å—Ç—ã–µ¬ª –ø—Ä–æ–≥–æ–Ω—ã, –¥—ã—Ä–∫–∏ –ø–æ –¥–∞—Ç–∞–º –∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ DWH
- üõ∞Ô∏è DAG —Å —Å–µ–Ω—Å–æ—Ä–æ–º –∏ –¥—Ä—É–≥–∏–º cron: –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å execution_delta –∏ —Ä–∞–±–æ—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è–º–∏
- üí£ –ü—Ä–æ–±–ª–µ–º–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤: —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ timeout –∏—Å—Ç—ë–∫ –∏ –ø–æ—á–µ–º—É retries –Ω–µ —Å–ø–∞—Å—É—Ç
- üìÖ ods_dag_without_catchup: –∫–∞–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ catchup –ª–æ–º–∞–µ—Ç –ª–æ–≥–∏–∫—É –∑–∞–≤–∏—Å–∏–º—ã—Ö DAG‚Äô–æ–≤
- üß™ –¢—Ä–∏ –ø–æ–¥—Ö–æ–¥–∞ –∫ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö DAGRun:
    - backfill —á–µ—Ä–µ–∑ CLI (–∏ –µ–≥–æ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏)
    - ¬´–ø—É—Å—Ç—ã—à–∫–∏¬ª –∏ –∑–∞—á–µ–º –æ–Ω–∏ –∏–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω—ã
    - –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π backfill —á–µ—Ä–µ–∑ Airflow REST API (api_backfill.py)
- üìä –ü—Ä–∏–º–µ—Ä –≤–∏—Ç—Ä–∏–Ω—ã dm.dm_count_registered_users: –æ—Ç ODS –¥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ DM-—Å–ª–æ—è
- üßµ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Sensors –≤ –ø—Ä–æ–¥–µ: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, —Ä–µ—Å—É—Ä—Å—ã scheduler, –∞–ª–µ—Ä—Ç–∏–Ω–≥

üóÇÔ∏è GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∫–æ–¥–æ–º: https://github.com/k0rsakov/pet_project_how_to_set_up_sensors_in_airflow

‚úâÔ∏è –í–æ–ø—Ä–æ—Å—ã, –æ–±—É—á–µ–Ω–∏–µ, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ ‚Äî –ø–∏—à–∏ –≤ –ª–∏—á–∫—É:
https://korsak0v.notion.site/Data-Engineer-185c62fdf79345eb9da9928356884ea0

üí° –í –∫–æ–Ω—Ü–µ –≤–∏–¥–µ–æ ‚Äî —á–µ–∫-–ª–∏—Å—Ç, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Sensors —Ç–∞–∫, —á—Ç–æ–±—ã DAG‚Äô–∏ –±—ã–ª–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–µ —Ç–µ—Ä—è–ª–∏ –¥–∞–Ω–Ω—ã–µ, –Ω–µ
–∑–∞—Å–∏—Ä–∞–ª–∏ –ª–æ–≥–∏ ¬´–≤–µ—á–Ω—ã–º –ø–æ–∫–∞–Ω–∏–µ–º¬ª –∏ –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è–ª–∏ —Ç–µ–±—è –≤—Ä—É—á–Ω—É—é –¥–æ–±–∏–≤–∞—Ç—å DAGRun —á–µ—Ä–µ–∑ backfill –∏ –∫–æ—Å—Ç—ã–ª–∏.

–¢–∞–π–º–∫–æ–¥—ã:

- 00:00 ‚Äì –ù–∞—á–∞–ª–æ
- 00:16 ‚Äì –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (—Å–±–æ—Ä–∫–∏)
- 01:52 ‚Äì –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (DWH)
- 02:07 ‚Äì –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ DAG –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- 05:08 ‚Äì –°–æ–∑–¥–∞–Ω–∏–µ DAG –±–µ–∑ —Å–µ–Ω—Å–æ—Ä–æ–≤ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- 09:31 ‚Äì –°–æ–∑–¥–∞–Ω–∏–µ DAG —Å —Å–µ–Ω—Å–æ—Ä–∞–º–∏ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–µ–Ω—Å–æ—Ä–æ–≤
- 15:39 ‚Äì –°–æ–∑–¥–∞–Ω–∏–µ DAG —Å —Å–µ–Ω—Å–æ—Ä–∞–º–∏ —Å –¥—Ä—É–≥–∏–º cron
- 20:35 ‚Äì –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç timeout
- 21:35 ‚Äì –†–∞–±–æ—Ç–∞ —Å –ø—É—Å—Ç—ã–º–∏ DAGRun. –†–∞–∑–±–æ—Ä catchup, backfill, Airflow API
- 30:32 ‚Äì –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#apacheairflow #airflow #sensors #externaltasksensor #dataengineering #etl #elt #dwh #python #catchup #backfill
#dataengineer #tutorial

## –û –ø—Ä–æ–µ–∫—Ç–µ

`backfill` —á–µ—Ä–µ–∑ CLI –¥–ª—è DAG `ods_dag_without_catchup`:

```bash
docker compose exec airflow-scheduler \
  airflow dags backfill \
    ods_dag_without_catchup \
    --start-date 2025-01-01 \
    --end-date 2025-11-17 \
    --mark-success
```

### –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
python3.12 -m venv venv && \
source venv/bin/activate && \
pip install --upgrade pip && \
pip install poetry && \
poetry lock && \
poetry install
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Airflow —á–µ—Ä–µ–∑ Docker

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º Airflow, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ [Dockerfile](Dockerfile)
–∏ [docker-compose.yaml](docker-compose.yaml).

–î–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Airflow, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:

```bash
docker-compose up -d
```

–í–µ–±-—Å–µ—Ä–≤–µ—Ä Airflow –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ http://localhost:8080/, –µ—Å–ª–∏ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–π —Ö–æ—Å—Ç, —Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏
–ø–æ —Ö–æ—Å—Ç—É http://0.0.0.0:8080/.

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –≤ —Ç–µ–∫—É—â—É—é —Å–±–æ—Ä–∫—É

–î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫–æ–π-—Ç–æ –ø–∞–∫–µ—Ç –≤ —Ç–µ–∫—É—â—É—é —Å–±–æ—Ä–∫—É, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

* –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ [Dockerfile](Dockerfile)
* –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:

```bash
docker-compose build
```

* –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É:

```bash
docker-compose up -d
```
